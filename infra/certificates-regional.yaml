AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Creates an ACM certificate for the backend API domain.
  This stack should be deployed in the primary region (e.g., eu-central-1).

Parameters:
  ProjectName:
    Type: String
    Default: angular-node-app
  HostedZoneId:
    Type: String
    Description: The Route 53 Hosted Zone ID for the domain (e.g., Z0123456789ABCDEFGHIJ).
  BackendDomainName:
    Type: String
    Default: api.couplebudget.usee.today

Resources:
  BackendCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref BackendDomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref BackendDomainName
          # HostedZoneId is not a valid property for DomainValidationOptions.
          # The DNS validation CNAME must be created as a Route53 Record using
          # the certificate's DomainValidationOptions.ResourceRecord attributes.
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-backend-cert'

  BackendCertificateValidationRecord:
    Type: AWS::Route53::RecordSet
    DependsOn: BackendCertificate
    Properties:
      HostedZoneId: !Ref HostedZoneId
      # Use the resource record provided by Certificate domain validation
      Name: !GetAtt BackendCertificate.DomainValidationOptions.0.ResourceRecord.Name
      Type: !GetAtt BackendCertificate.DomainValidationOptions.0.ResourceRecord.Type
      TTL: '300'
      ResourceRecords:
        - !GetAtt BackendCertificate.DomainValidationOptions.0.ResourceRecord.Value

Outputs:
  CertificateArn:
    Description: ARN of the ACM certificate for the backend API.
    Value: !Ref BackendCertificate
    Export:
      Name: !Sub '${ProjectName}:BackendCertificateArn'
