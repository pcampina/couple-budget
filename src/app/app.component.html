<main class="page">
  <header class="header">
    <h1>Couple's Expenses</h1>
    <p class="muted">Two salaries ⇒ percentages ⇒ each expense already split automatically (€).</p>
  </header>

  <section class="card">
    <h2>Configuration</h2>
    <div class="grid">
      @for (p of store.participants(); track p.id) {
        <div>
          <label>
            <span>Person name</span>
            <input [value]="p.name" (change)="store.setParticipantName(p.id, $any($event.target).value)"/>
          </label>
          <label>
            <span>Income (€)</span>
            <input type="number" step="0.01" [ngModel]="p.income" (ngModelChange)="store.setParticipantIncome(p.id, $event)" />
          </label>
          <div style="margin-top:8px">
            <button class="btn btn--ghost" (click)="store.removeParticipant(p.id)" [disabled]="store.participantCount() <= 2">Remove</button>
          </div>
        </div>
      }
    </div>
    <div style="margin-top:12px">
      <button class="btn" (click)="store.addParticipant()">Add person</button>
    </div>

    <div class="chips">
      <span class="chip">Total: {{ store.totalIncome() | currency:'EUR':'symbol':'1.2-2' }}</span>
      @for (s of store.participantShares(); track s.id) {
        <span class="chip">{{ s.name }}: {{ (s.share * 100) | number:'1.0-2' }}%</span>
      }
    </div>
  </section>

  <section class="card">
    <h2>Expenses</h2>

    <form class="add-row" (submit)="$event.preventDefault(); addFromForm()">
      <input placeholder="Expense" [(ngModel)]="newName" name="name" required />
      <input placeholder="Total amount (€)" type="number" step="0.01" [(ngModel)]="newTotal" name="total" required />
      <button class="btn" [disabled]="!newName || !isValid(newTotal)">Add</button>
    </form>

    <div class="table" role="table" aria-label="Expense list">
      <div class="thead" role="rowgroup">
        <div class="tr" role="row" [style.grid-template-columns]="gridTemplateColumns()">
          <div class="th" role="columnheader">Expense</div>
          <div class="th num" role="columnheader">Total amount (€)</div>
          @for (p of store.participants(); track p.id) {
            <div class="th num" role="columnheader">{{ p.name }}</div>
          }
          <div class="th" role="columnheader"></div>
        </div>
      </div>

      <div class="tbody" role="rowgroup">
        @for (e of store.expensesWithAllocations(); track e.id) {
          <div class="tr" role="row" [style.grid-template-columns]="gridTemplateColumns()">
            <div class="td">
              <input class="cell-input" [value]="e.name" (change)="store.updateExpense(e.id, { name: $any($event.target).value })"/>
            </div>
            <div class="td num">
              <input class="cell-input num" type="number" step="0.01"
                      [value]="e.total"
                      (change)="store.updateExpense(e.id, { total: toNumber($any($event.target).value) })"/>
            </div>
            @for (p of store.participants(); track p.id) {
              <div class="td num">{{ e.allocations[p.id] | currency:'EUR':'symbol':'1.2-2' }}</div>
            }
            <div class="td actions"><button class="link" (click)="store.removeExpense(e.id)">remove</button></div>
          </div>
        }
        @if (store.expensesWithAllocations().length === 0) {
          <div class="tr empty"><div class="td" colspan="5">No expenses yet.</div></div>
        }
      </div>

      <div class="tfoot" role="rowgroup">
        <div class="tr" [style.grid-template-columns]="gridTemplateColumns()">
          <div class="td bold">Totals</div>
          <div class="td num bold">{{ store.totalExpenses() | currency:'EUR':'symbol':'1.2-2' }}</div>
          @for (p of store.participants(); track p.id) {
            <div class="td num bold">{{ store.totalsPerParticipant()[p.id] | currency:'EUR':'symbol':'1.2-2' }}</div>
          }
          <div class="td"></div>
        </div>
      </div>
    </div>
  </section>
</main>
