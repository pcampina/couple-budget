<section class="budget__section card card--glass">
  <h2>Transactions</h2>

  <app-groups-header></app-groups-header>

  <!-- Group split summary -->
  <div class="chip-group" aria-label="Split by income">
    @for (s of store.participantShares(); track s.id) {
    <span class="chip">{{ s.name }}: {{ (s.share || 0) * 100 | number:'1.0-2' }}%</span>
    }
  </div>

  <!-- Group selection and creation moved to group list page -->

  @if (groupService.selectedGroup()) {
  <form class="form-add" (submit)="$event.preventDefault(); addFromForm()">
    <input class="input" placeholder="Transaction" [(ngModel)]="newName" name="name" required />
    <select class="input" [(ngModel)]="newType" name="type">
      @for (t of types(); track t.code) {
      <option [ngValue]="t.code">{{ t.name }}</option>
      }
    </select>
    <input class="input input--num" placeholder="Amount (€)" type="number" step="0.01" [(ngModel)]="newTotal"
      name="total" required />
    <button class="button button--success"
      [disabled]="!newName || !isValid(newTotal) || (!usingApi && store.participantCount() === 0) || (usingApi && !canMutateTransactions())">Add</button>
  </form>
  }

  @if (groupService.selectedGroup()) {
  <div class="data-table" role="table" aria-label="Transactions list">
    <div class="data-table__head" role="rowgroup">
      <div class="data-table__row" role="row" [style.grid-template-columns]="gridTemplateColumns()">
        <div class="data-table__cell data-table__cell--head" role="columnheader">Transaction</div>
        <div class="data-table__cell data-table__cell--head" role="columnheader">Type</div>
        <div class="data-table__cell data-table__cell--head data-table__cell--num" role="columnheader">Amount (€)</div>
        <div class="data-table__cell data-table__cell--head" role="columnheader">Paid</div>
        @for (p of store.participants(); track p.id) {
        <div class="data-table__cell data-table__cell--head data-table__cell--num" role="columnheader">{{ p.name }}
        </div>
        }
        <div class="data-table__cell data-table__cell--head" role="columnheader"></div>
      </div>
    </div>

    <div class="data-table__body" role="rowgroup">
      @for (t of store.transactionsWithAllocations(); track t.id) {
      <div class="data-table__row" role="row" [style.grid-template-columns]="gridTemplateColumns()">
        <div class="data-table__cell">
          <input class="input input--cell" [disabled]="usingApi && !canMutateTransactions()"
            [value]="getDraftValue(t.id, 'name', t.name)" (input)="onTransactionInput(t.id, 'name', $any($event.target).value)"
            (keyup.enter)="saveTransaction(t.id)" />
        </div>
        <div class="data-table__cell">
          <span class="chip">{{ txTypeLabel(t) }}</span>
        </div>
        <div class="data-table__cell data-table__cell--num">
          <input class="input input--cell input--num" type="number" step="0.01"
            [disabled]="usingApi && !canMutateTransactions()" [value]="getDraftValue(t.id, 'total', t.total)"
            (input)="onTransactionInput(t.id, 'total', toNumber($any($event.target).value))"
            (keyup.enter)="saveTransaction(t.id)" />
        </div>
        <div class="data-table__cell">
          @if (txTypeLabel(t) === 'Expense') {
          <label style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" [checked]="!!t.paid" (change)="togglePaid(t.id, $any($event.target).checked)"
              [disabled]="usingApi && !canMutateTransactions()" />
            <span class="text text--muted">{{ t.paid ? 'paid' : 'unpaid' }}</span>
          </label>
          }
        </div>
        @for (p of store.participants(); track p.id) {
        <div class="data-table__cell data-table__cell--num">{{ t.allocations[p.id] | currency:'EUR':'symbol':'1.2-2' }}
        </div>
        }
        <div class="data-table__cell data-table__cell--actions">
          @if (isTransactionDirty(t.id)) {
          <button class="button button--sm" (click)="saveTransaction(t.id)">Save</button>
          }
          <button class="button button--danger-ghost button--sm" [disabled]="usingApi && !canMutateTransactions()"
            (click)="removeTransactionAction(t.id)" [attr.aria-label]="'Remove transaction ' + t.name">Remove</button>
        </div>
      </div>
      }
      @if (store.transactionsWithAllocations().length === 0) {
      <div class="data-table__row data-table__row--empty">
        <div class="data-table__cell" colspan="5">No transactions yet.</div>
      </div>
      }
    </div>
  </div>
  }

  <!-- Pagination hidden while allocations are server-computed per expense date -->
</section>

<!-- Members & invites moved to Group settings page -->